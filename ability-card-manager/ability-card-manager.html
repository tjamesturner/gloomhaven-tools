<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gloomhaven Card Browser</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 20px;
          background: url('https://raw.githubusercontent.com/cmlenius/gloomhaven-card-browser/images/images/background.jpeg') repeat;
          background-size: auto;
        }

        .controls {
          display:flex;
          flex-wrap:wrap;
          gap:10px;
          align-items:center;
          margin-bottom:12px;
        }

        label { font-size:14px; margin-right:6px; }
        select, button { font-size:14px; padding:6px 8px; }

        #gallery {
          display:grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap:10px;
        }

        .card {
          position:relative;
          border-radius:8px;
          overflow:hidden;
          padding:4px;
          background:#fff;
          box-shadow:0 0 4px rgba(0,0,0,0.12);
          display:flex;
          align-items:center;
          justify-content:center;
        }

        .card img {
          width:100%;
          display:block;
          border-radius:6px;
          box-sizing:border-box;
          cursor:pointer;
        }

        /* Selection highlight (blueish) */
        .selected {
          outline:4px solid #2196f3;
          outline-offset:2px;
        }

        /* Area border colors */
        .hand { border:3px solid #9e9e9e; }
        .play { border:3px solid #2e8b57; }
        .discard { border:3px solid #ff8c00; }
        .active { border:3px solid #1e90ff; }
        .burn { border:3px solid #d32f2f; }

        /* Buttons */
        button {
          border-radius:6px;
          border:1px solid #aaa;
          background:#f2f2f2;
          cursor:pointer;
        }
        button:hover { background:#e0e0e0; }

        /* Mode buttons */
        .mode-btn.active {
          background:#4caf50;
          color:white;
          border-color:#388e3c;
        }

        /* Hidden controls in setup mode */
        .hidden { display:none; }

        @media (max-width:480px){
          .controls { gap:8px; }
          select { font-size:13px; padding:6px; }
        }
    </style>
</head>
<body>
<div class="controls">
    <label>Mode:</label>
    <button id="setupBtn" class="mode-btn">Setup</button>
    <button id="playBtn" class="mode-btn">Play</button>

    <label for="activeClasses">Active Classes:</label>
    <select id="activeClasses" multiple size="4"></select>

    <label for="classFilter">Class:</label>
    <select id="classFilter"><option value="all">All</option></select>
</div>

<!-- Area Filter + Buttons -->
<div class="controls area-controls">
    <label for="areaFilter">Filter Area:</label>
    <select id="areaFilter">
        <option value="all">All</option>
        <option value="hand">Hand</option>
        <option value="play">Play</option>
        <option value="discard">Discard</option>
        <option value="active">Active</option>
        <option value="burn">Burn</option>
    </select>
    <button id="filterHandBtn">Hand</button>
    <button id="filterPlayBtn">Play</button>
</div>

<!-- Move Area Controls -->
<div class="controls area-controls">
    <label for="bulkAreaSelect">Move to Area:</label>
    <select id="bulkAreaSelect">
        <option value="">--Select Area--</option>
        <option value="hand">Hand</option>
        <option value="play">Play</option>
        <option value="discard">Discard</option>
        <option value="active">Active</option>
        <option value="burn">Burn</option>
    </select>

    <button id="setHandBtn">Hand</button>
    <button id="setPlayBtn">Play</button>
</div>

<div id="gallery"></div>

<script type="module">
    import { images, allClasses } from './config.js';

    const gallery = document.getElementById('gallery');
    const activeClassesSelect = document.getElementById('activeClasses');
    const classFilter = document.getElementById('classFilter');
    const areaFilter = document.getElementById('areaFilter');
    const bulkAreaSelect = document.getElementById('bulkAreaSelect');
    const setHandBtn = document.getElementById('setHandBtn');
    const setPlayBtn = document.getElementById('setPlayBtn');
    const filterHandBtn = document.getElementById('filterHandBtn');
    const filterPlayBtn = document.getElementById('filterPlayBtn');
    const setupBtn = document.getElementById('setupBtn');
    const playBtn = document.getElementById('playBtn');
    const areaControls = document.querySelectorAll('.area-controls');

    let mode = 'setup';
    let selectedCards = new Set();

    function saveState(){
      const state = {
        mode,
        activeClasses: Array.from(activeClassesSelect.selectedOptions).map(o=>o.value),
        images
      };
      localStorage.setItem('ghState', JSON.stringify(state));
    }

    function loadState(){
      const s = localStorage.getItem('ghState');
      if(!s) return;
      try{
        const obj = JSON.parse(s);
        if(obj.mode) mode = obj.mode;
        if(Array.isArray(obj.activeClasses)){
          for(const opt of activeClassesSelect.options){
            opt.selected = obj.activeClasses.includes(opt.value);
          }
        }
        if(Array.isArray(obj.images)){
          const savedMap = new Map(obj.images.map(it=>[it.url,it]));
          images.forEach(img=>{
            const saved = savedMap.get(img.url);
            if(saved){
              img.status = saved.status || img.status;
              img.playable = saved.playable ?? img.playable;
            }
          });
        }
      }catch(e){ console.warn('Failed to load state:', e); }
    }

    function populateActiveClasses(){
      activeClassesSelect.innerHTML='';
      allClasses.forEach(cls=>{
        const opt=document.createElement('option');
        opt.value=cls; opt.textContent=cls;
        activeClassesSelect.appendChild(opt);
      });
    }
    function updateClassFilter(){
      const selected = Array.from(activeClassesSelect.selectedOptions).map(o=>o.value);
      classFilter.innerHTML='<option value="all">All</option>';
      selected.forEach(cls=>{
        const opt=document.createElement('option');
        opt.value=cls; opt.textContent=cls;
        classFilter.appendChild(opt);
      });
    }

    function setMode(newMode){
      mode=newMode;
      if(mode==='play') selectedCards.clear();
      else if(mode==='setup'){
        selectedCards.clear();
        images.forEach(img=>{ if(img.playable) selectedCards.add(img); });
      }
      setupBtn.classList.toggle('active',mode==='setup');
      playBtn.classList.toggle('active',mode==='play');
      areaControls.forEach(el=>el.classList.toggle('hidden',mode==='setup'));
      saveState();
      renderGallery();
    }

    function renderGallery(){
      const areaVal=areaFilter.value;
      const activeSelected=Array.from(activeClassesSelect.selectedOptions).map(o=>o.value);
      const classVal=classFilter.value;
      if(activeSelected.length===0){
        gallery.innerHTML='<p style="grid-column:1/-1;color:#666">No active classes selected.</p>';
        return;
      }

      if(mode==='setup'){
        selectedCards.clear();
        images.forEach(img=>{ if(img.playable) selectedCards.add(img); });
      }

      gallery.innerHTML='';
      images.forEach(img=>{
        if(!activeSelected.includes(img.class)) return;
        if(classVal!=='all' && img.class!==classVal) return;
        if(mode==='play' && !img.playable) return;
        if(mode==='play' && areaVal!=='all' && img.status!==areaVal) return;

        const card=document.createElement('div');
        card.className='card '+(img.status||'hand');
        const el=document.createElement('img');
        el.src=img.url; el.alt=img.class;
        if(selectedCards.has(img)) card.classList.add('selected');
        el.addEventListener('click',()=>{
          if(mode==='setup'){
            img.playable=!img.playable;
            if(img.playable) selectedCards.add(img);
            else selectedCards.delete(img);
          } else {
            if(selectedCards.has(img)) selectedCards.delete(img);
            else selectedCards.add(img);
          }
          saveState(); renderGallery();
        });
        card.appendChild(el);
        gallery.appendChild(card);
      });
    }

    /* Bulk move */
    bulkAreaSelect.addEventListener('change',()=>{
      if(mode==='setup') return; // disable in setup
      const newArea=bulkAreaSelect.value;
      if(!newArea) return;
      selectedCards.forEach(img=>{ img.status=newArea; });
      selectedCards.clear();
      bulkAreaSelect.value='';
      saveState(); renderGallery();
    });

    /* Quick-set buttons for bulk move */
    setHandBtn.addEventListener('click',()=>{
      if(mode==='setup') return;
      bulkAreaSelect.value='hand';
      bulkAreaSelect.dispatchEvent(new Event('change'));
    });
    setPlayBtn.addEventListener('click',()=>{
      if(mode==='setup') return;
      bulkAreaSelect.value='play';
      bulkAreaSelect.dispatchEvent(new Event('change'));
    });

    /* Filter area buttons */
    filterHandBtn.addEventListener('click',()=>{areaFilter.value='hand';renderGallery();});
    filterPlayBtn.addEventListener('click',()=>{areaFilter.value='play';renderGallery();});

    /* Other controls */
    areaFilter.addEventListener('change',renderGallery);
    activeClassesSelect.addEventListener('change',()=>{
      const sel=Array.from(activeClassesSelect.selectedOptions);
      if(sel.length>4){ sel[sel.length-1].selected=false; alert('You can select up to 4 active classes.'); }
      updateClassFilter(); saveState(); renderGallery();
    });
    classFilter.addEventListener('change',renderGallery);
    setupBtn.addEventListener('click',()=>setMode('setup'));
    playBtn.addEventListener('click',()=>setMode('play'));

    /* Init */
    function init(){
      populateActiveClasses();
      loadState();
      updateClassFilter();
      setMode(mode);
    }
    init();
</script>
</body>
</html>
