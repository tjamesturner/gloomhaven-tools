<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gloomhaven Card Browser</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        h1 { text-align: center; }
        .filters { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        select { padding: 6px; font-size: 14px; }
        .controls { margin-top: 10px; text-align: center; }
        button { padding: 6px 12px; font-size: 14px; margin-bottom: 10px; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.2); text-align: center; }
        .card img { max-width: 100%; border-radius: 6px; }
    </style>
</head>
<body>
<h1>Gloomhaven Card Browser</h1>

<div class="filters">
    <label>
        Mode:<br>
        <select id="modeSelector">
            <option value="all">All Areas</option>
            <option value="setup">Setup</option>
            <option value="play">Play</option>
        </select>
    </label>

    <label>
        Active Classes (pick up to 4):<br>
        <select id="activeClasses" multiple size="6"></select>
    </label>
    <label>
        Class:<br>
        <select id="classFilter">
            <option value="all">All</option>
        </select>
    </label>
    <label>
        Area:<br>
        <select id="areaFilter">
            <option value="all">All</option>
            <option value="hand">Hand</option>
            <option value="active">Active</option>
            <option value="play">Play</option>
            <option value="discard">Discard</option>
            <option value="burn">Burn</option>
            <option value="locked">Locked</option>
            <option value="unused">Unused</option>
        </select>
    </label>
</div>

<div class="controls">
    <button id="resetAll">Reset All Statuses</button>
</div>

<div class="gallery" id="gallery"></div>

<script src="config.js"></script>
<script>
    const gallery = document.getElementById("gallery");
    const activeClasses = document.getElementById("activeClasses");
    const classFilter = document.getElementById("classFilter");
    const areaFilter = document.getElementById("areaFilter");
    const resetAllBtn = document.getElementById("resetAll");
    const modeSelector = document.getElementById("modeSelector");

    // Define allowed areas per mode
    const playAreas = ["hand","play","discard","active","burn"];
    const setupAreas = ["hand","locked","unused"];
    const allAreas = ["hand","active","play","discard","burn","locked","unused"];

    // Convert any old "unused level one/level 2+" to "unused"
    images.forEach(img => {
      if(img.status === "unused level one" || img.status === "unused level 2+") img.status = "unused";
    });

    // Persistence
    function loadSavedStatuses() {
      const saved = localStorage.getItem("cardStatuses");
      if (saved) {
        const obj = JSON.parse(saved);
        images.forEach(img => { if (obj[img.url]) img.status = obj[img.url]; });
      }
    }
    function saveStatuses() {
      const obj = {};
      images.forEach(img => obj[img.url] = img.status);
      localStorage.setItem("cardStatuses", JSON.stringify(obj));
    }
    function resetAllStatuses() {
      images.forEach(img => img.status = "hand");
      saveStatuses();
      renderGallery();
    }

    // Populate Active Classes
    function populateActiveClasses() {
      allClasses.forEach(cls => {
        const opt = document.createElement("option");
        opt.value = cls;
        opt.textContent = cls;
        activeClasses.appendChild(opt);
      });
    }

    // Update Class filter based on Active Classes
    function updateClassFilter() {
      const selected = Array.from(activeClasses.selectedOptions).map(o => o.value);
      classFilter.innerHTML = "<option value='all'>All</option>";
      selected.forEach(cls => {
        const opt = document.createElement("option");
        opt.value = cls;
        opt.textContent = cls;
        classFilter.appendChild(opt);
      });
    }

    // Update Area filter based on Mode
    function updateAreaFilter() {
      const mode = modeSelector.value;
      let allowed = [];
      if(mode === "play") allowed = playAreas;
      else if(mode === "setup") allowed = setupAreas;
      else allowed = allAreas;

      // Reset selected area if invalid
      if(!allowed.includes(areaFilter.value) && areaFilter.value !== "all") areaFilter.value = "all";

      areaFilter.innerHTML = "<option value='all'>All</option>";
      allowed.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        areaFilter.appendChild(opt);
      });

      // If setup mode, move any cards in play mode areas into hand
      if(mode === "setup") {
        images.forEach(img => {
          if(playAreas.includes(img.status)) img.status = "hand";
        });
        saveStatuses();
      }
    }

    // Render gallery
    function renderGallery() {
      const areaVal = areaFilter.value;
      const mode = modeSelector.value;
      const allowedAreas = mode === "play" ? playAreas
                          : mode === "setup" ? setupAreas
                          : allAreas;

      // Determine which classes to show
      const selectedActiveClasses = Array.from(activeClasses.selectedOptions).map(o => o.value);
      let classVal = classFilter.value;

      gallery.innerHTML = "";

      images.forEach(img => {
        // Only show images whose class is in the active classes
        if (selectedActiveClasses.length === 0) return; // nothing selected

        const matchesClass = classVal === "all"
          ? selectedActiveClasses.includes(img.class)
          : img.class === classVal;

        const matchesArea = areaVal === "all" || img.status === areaVal;

        if (matchesClass && matchesArea) {
          const card = document.createElement("div");
          card.className = "card";

          const select = document.createElement("select");
          allowedAreas.forEach(st => {
            const opt = document.createElement("option");
            opt.value = st;
            opt.textContent = st;
            if (st === img.status) opt.selected = true;
            select.appendChild(opt);
          });

          select.addEventListener("change", () => {
            img.status = select.value;
            saveStatuses();
            renderGallery();
          });

          card.innerHTML = `<img src="${img.url}" alt="${img.class}">`;
          card.appendChild(select);
          gallery.appendChild(card);
        }
      });
    }


    // Events
    activeClasses.addEventListener("change", () => {
      if (activeClasses.selectedOptions.length > 4) {
        alert("You can only select up to 4 active classes.");
        Array.from(activeClasses.options).forEach(opt => opt.selected = false);
      }
      updateClassFilter();
      renderGallery();
    });
    classFilter.addEventListener("change", renderGallery);
    areaFilter.addEventListener("change", renderGallery);
    modeSelector.addEventListener("change", () => {
      updateAreaFilter();
      renderGallery();
    });
    resetAllBtn.addEventListener("click", () => {
      if (confirm("Reset all statuses to 'hand'?")) resetAllStatuses();
    });

    // Init
    loadSavedStatuses();
    populateActiveClasses();
    updateClassFilter();
    updateAreaFilter();
    renderGallery();
</script>
</body>
</html>
