<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gloomhaven Card Browser</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 20px;
          background: url('https://raw.githubusercontent.com/cmlenius/gloomhaven-card-browser/images/images/background.jpeg') repeat;
          background-size: auto;
        }

        h1 { text-align: center; }

        .filters { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        select { padding: 6px; font-size: 14px; }
        .controls { margin-top: 10px; text-align: center; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 6px 12px; font-size: 14px; margin-bottom: 10px; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.2); text-align: center; }
        .card img { max-width: 100%; border-radius: 6px; cursor: pointer; box-sizing: border-box; }
    </style>
</head>
<body>
<h1>Gloomhaven Card Browser</h1>

<div class="filters">
    <label>
        Mode:<br>
        <select id="modeSelector">
            <option value="all">All Areas</option>
            <option value="setup">Setup</option>
            <option value="play">Play</option>
        </select>
    </label>

    <label>
        Active Classes (pick up to 4):<br>
        <select id="activeClasses" multiple size="6"></select>
    </label>

    <label>
        Class:<br>
        <select id="classFilter"><option value="all">All</option></select>
    </label>

    <label>
        Area:<br>
        <select id="areaFilter">
            <option value="all">All</option>
            <option value="hand">Hand</option>
            <option value="active">Active</option>
            <option value="play">Play</option>
            <option value="discard">Discard</option>
            <option value="burn">Burn</option>
        </select>
    </label>
</div>

<div class="controls">
    <label>
        Update Area for Selected Cards:
        <select id="bulkAreaSelect">
            <option value="">--Select Area--</option>
            <option value="hand">Hand</option>
            <option value="active">Active</option>
            <option value="play">Play</option>
            <option value="discard">Discard</option>
            <option value="burn">Burn</option>
        </select>
    </label>
    <button id="moveToHand">Move Play Mode Cards to Hand</button>
    <button id="moveToUnused">Move Play Mode Cards to Unused</button>
</div>

<div class="gallery" id="gallery"></div>

<script src="config.js"></script>
<script>
    const gallery = document.getElementById("gallery");
    const activeClasses = document.getElementById("activeClasses");
    const classFilter = document.getElementById("classFilter");
    const areaFilter = document.getElementById("areaFilter");
    const bulkAreaSelect = document.getElementById("bulkAreaSelect");
    const moveToHandBtn = document.getElementById("moveToHand");
    const moveToUnusedBtn = document.getElementById("moveToUnused");
    const modeSelector = document.getElementById("modeSelector");

    const playAreas = ["hand","play","discard","active","burn"];
    const allAreas = ["hand","active","play","discard","burn"];
    const areaColors = {
      hand: "gray", active: "blue", play: "green", discard: "orange", burn: "red"
    };

    let selectedCards = new Set();

    function saveState() {
      const obj = {
        statuses: {},
        mode: modeSelector.value,
        activeClasses: Array.from(activeClasses.selectedOptions).map(o => o.value),
        playable: {}
      };
      images.forEach(img => {
        obj.statuses[img.url] = img.status;
        obj.playable[img.url] = img.playable;
      });
      localStorage.setItem("cardState", JSON.stringify(obj));
    }

    function loadSavedState() {
      const saved = localStorage.getItem("cardState");
      if(saved) {
        const obj = JSON.parse(saved);
        images.forEach(img => {
          if(obj.statuses[img.url]) img.status = obj.statuses[img.url];
          if(obj.playable[img.url] !== undefined) img.playable = obj.playable[img.url];
        });
        if(obj.mode) modeSelector.value = obj.mode;
        if(obj.activeClasses) {
          Array.from(activeClasses.options).forEach(opt => {
            opt.selected = obj.activeClasses.includes(opt.value);
          });
        }
      }
    }

    function populateActiveClasses() {
      allClasses.forEach(cls => {
        const opt = document.createElement("option");
        opt.value = cls;
        opt.textContent = cls;
        activeClasses.appendChild(opt);
      });
    }

    function updateClassFilter() {
      const selected = Array.from(activeClasses.selectedOptions).map(o => o.value);
      classFilter.innerHTML = "<option value='all'>All</option>";
      selected.forEach(cls => {
        const opt = document.createElement("option");
        opt.value = cls;
        opt.textContent = cls;
        classFilter.appendChild(opt);
      });
    }

    function updateAreaFilter() {
      const mode = modeSelector.value;
      areaFilter.innerHTML = "<option value='all'>All</option>";
      allAreas.forEach(a => areaFilter.appendChild(new Option(a, a)));
      if(!allAreas.includes(areaFilter.value) && areaFilter.value !== "all") areaFilter.value = "all";
    }

    function renderGallery() {
      const mode = modeSelector.value;
      const areaVal = areaFilter.value;
      const selectedActiveClasses = Array.from(activeClasses.selectedOptions).map(o => o.value);
      const classVal = classFilter.value;

      if(mode === "setup") {
        // auto-select playable cards
        selectedCards.clear();
        images.forEach(img => { if(img.playable) selectedCards.add(img); });
      }

      gallery.innerHTML = "";
      images.forEach(img => {
        if(selectedActiveClasses.length === 0) return;
        const matchesClass = classVal === "all" ? selectedActiveClasses.includes(img.class) : img.class === classVal;
        const matchesArea = areaVal === "all" || img.status === areaVal;
        if(!matchesClass || !matchesArea) return;
        if(mode === "play" && !img.playable) return;

        const card = document.createElement("div");
        card.className = "card";

        const imgElement = document.createElement("img");
        imgElement.src = img.url;
        imgElement.alt = img.class;
        imgElement.style.border = `4px solid ${areaColors[img.status] || "black"}`;
        imgElement.style.borderRadius = "6px";
        imgElement.style.cursor = "pointer";
        imgElement.style.boxSizing = "border-box";
        if(selectedCards.has(img)) imgElement.style.boxShadow = "0 0 10px 4px yellow";
        else imgElement.style.boxShadow = "";

        imgElement.addEventListener("click", () => {
          if(mode === "setup") { img.playable = true; selectedCards.add(img); }
          else { if(selectedCards.has(img)) selectedCards.delete(img); else selectedCards.add(img); }
          saveState();
          renderGallery();
        });

        card.appendChild(imgElement);
        gallery.appendChild(card);
      });
    }

    // Bulk area update
    bulkAreaSelect.addEventListener("change", () => {
      const newArea = bulkAreaSelect.value;
      if(!newArea) return;
      selectedCards.forEach(img => img.status = newArea);
      selectedCards.clear();
      bulkAreaSelect.value = "";
      saveState();
      renderGallery();
    });

    // Move Play Mode Cards
    function movePlayModeCards(targetArea) {
      images.forEach(img => { if(playAreas.includes(img.status)) img.status = targetArea; });
      saveState();
      renderGallery();
    }

    moveToHandBtn.addEventListener("click", () => movePlayModeCards("hand"));
    moveToUnusedBtn.addEventListener("click", () => movePlayModeCards("unused"));

    activeClasses.addEventListener("change", () => {
      if(activeClasses.selectedOptions.length > 4) {
        alert("You can only select up to 4 active classes.");
        Array.from(activeClasses.options).forEach(opt => opt.selected = false);
      }
      updateClassFilter();
      saveState();
      renderGallery();
    });

    classFilter.addEventListener("change", renderGallery);
    areaFilter.addEventListener("change", renderGallery);
    modeSelector.addEventListener("change", () => { updateAreaFilter(); saveState(); renderGallery(); });

    // Initialize
    populateActiveClasses();
    loadSavedState();
    updateClassFilter();
    updateAreaFilter();
    renderGallery();
</script>
</body>
</html>
